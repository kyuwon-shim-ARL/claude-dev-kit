name: TADD Test-First Integrity Enforcement
on:
  push:
    branches: [ main, develop ]
  pull_request:
    types: [ opened, synchronize, reopened ]

jobs:
  enforce-test-integrity:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ì „ì²´ ížˆìŠ¤í† ë¦¬ í•„ìš”
    
    - name: Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Install Dependencies
      run: |
        pip install pytest pytest-cov coverage
        if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
        if [ -f requirements-dev.txt ]; then pip install -r requirements-dev.txt; fi
    
    - name: Count and Verify Tests
      id: test_count
      run: |
        TOTAL=$(find . -name 'test*.py' -exec grep -c 'def test_' {} \; 2>/dev/null | awk '{sum+=$1} END {print sum}')
        echo "total_tests=$TOTAL" >> $GITHUB_OUTPUT
        echo "ðŸ“Š ì´ í…ŒìŠ¤íŠ¸ ê°œìˆ˜: $TOTAL"
        
        # ì´ì „ ì»¤ë°‹ê³¼ ë¹„êµ
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          BASE_COUNT=$(git show ${{ github.event.pull_request.base.sha }}:tests/ 2>/dev/null | grep -c 'def test_' || echo 0)
          if [ "$TOTAL" -lt "$BASE_COUNT" ]; then
            echo "::error::í…ŒìŠ¤íŠ¸ ê°ì†Œ ê°ì§€! $BASE_COUNT â†’ $TOTAL"
            exit 1
          fi
        fi
    
    - name: Run All Tests (No Skip Allowed)
      run: |
        pytest --strict-markers --tb=short -v
    
    - name: Check Test Quality
      run: |
        # Theater Testing íŒ¨í„´ ê²€ì‚¬ (ì‹¤ì œ assertionë§Œ ê²€ì‚¬)
        if find . -name "test*.py" -exec grep -l "^\s*assert.*is not None$\|^\s*assert True$" {} \; | head -1; then
          echo "::error::Theater Testing íŒ¨í„´ ê°ì§€!"
          exit 1
        fi
    
    - name: Analyze Mock Usage
      run: |
        # Mock ì‚¬ìš©ë¥  ê³„ì‚°
        MOCK_COUNT=$(find . -name "*.py" -exec grep -c "mock\|Mock" {} \; 2>/dev/null | awk '{sum+=$1} END {print sum}')
        TOTAL_LINES=$(find . -name "test*.py" -exec wc -l {} \; | awk '{sum+=$1} END {print sum}')
        
        if [ "$TOTAL_LINES" -gt 0 ]; then
          MOCK_PERCENTAGE=$((MOCK_COUNT * 100 / TOTAL_LINES))
          echo "ðŸ“Š Mock ì‚¬ìš©ë¥ : ${MOCK_PERCENTAGE}%"
          
          if [ "$MOCK_PERCENTAGE" -gt 20 ]; then
            echo "::warning::Mock ì‚¬ìš©ë¥ ì´ 20%ë¥¼ ì´ˆê³¼í•©ë‹ˆë‹¤ (${MOCK_PERCENTAGE}%)"
          fi
        fi
    
    - name: Generate Test Report
      if: always()
      run: |
        echo "## ðŸ“‹ Test Integrity Report" >> $GITHUB_STEP_SUMMARY
        echo "- ì´ í…ŒìŠ¤íŠ¸: ${{ steps.test_count.outputs.total_tests }}ê°œ" >> $GITHUB_STEP_SUMMARY
        echo "- ìƒíƒœ: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY
        echo "- ì‹œê°„: $(date)" >> $GITHUB_STEP_SUMMARY
