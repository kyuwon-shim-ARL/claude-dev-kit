<!--
@meta
id: command_20250905_test_integrity
type: command
scope: operational
status: active
created: 2025-09-05
updated: 2025-09-05
tags: test, integrity, enforcement
-->

🛡️ **테스트강화 (Test Integrity Enforcement System)**

**📚 컨텍스트 자동 로딩:**
- .github/workflows/*.yml (CI/CD 설정)
- tests/ 디렉토리 구조
- pytest.ini 또는 setup.cfg
- 최근 테스트 실행 결과

**🎯 역할: AI의 테스트 우회/조작 방지 시스템 구축**

## 1. 🔍 **현재 상태 진단 (20% 비중)**

**테스트 환경 분석:**
```python
def diagnose_test_environment():
    checks = {
        "pytest_installed": check_pytest(),
        "ci_configured": check_github_actions(),
        "pre_commit_hooks": check_git_hooks(),
        "test_coverage": measure_coverage(),
        "mock_usage": analyze_mock_patterns(),
        "test_quality": assess_test_quality()
    }
    return generate_diagnosis_report(checks)
```

## 2. 🚨 **무결성 강제 시스템 설치 (40% 비중)**

### 자동 설치 스크립트:
```bash
#!/bin/bash
# install_test_integrity.sh

echo "🛡️ Installing Test Integrity System..."

# 1. Pre-commit hooks 설치
cat > .git/hooks/pre-commit << 'EOF'
#!/bin/bash
# Test Integrity Check

# 테스트 개수 감소 방지
BEFORE=$(git show HEAD:tests/ 2>/dev/null | grep -c "def test_" || echo 0)
CURRENT=$(find tests/ -name "*.py" -exec grep -c "def test_" {} \; | awk '{sum+=$1} END {print sum}')

if [ "$CURRENT" -lt "$BEFORE" ]; then
    echo "❌ 테스트 삭제 감지! ($BEFORE → $CURRENT)"
    echo "💡 테스트를 삭제하지 말고 수정하세요"
    exit 1
fi

# 실제 테스트 실행
pytest --tb=short --strict-markers || exit 1

echo "✅ Test integrity verified"
EOF
chmod +x .git/hooks/pre-commit

# 2. GitHub Actions 워크플로우 생성
mkdir -p .github/workflows
cat > .github/workflows/test-integrity.yml << 'EOF'
name: Test Integrity Enforcement
on: [push, pull_request]

jobs:
  enforce-integrity:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Count Tests
        id: count
        run: |
          echo "total=$(find . -name 'test*.py' -exec grep -c 'def test_' {} \; | awk '{sum+=$1} END {print sum}')" >> $GITHUB_OUTPUT
      
      - name: Run All Tests
        run: |
          pip install pytest pytest-cov
          pytest --no-skip --strict-markers
      
      - name: Check Mock Usage
        run: |
          python scripts/detect_mock_usage.py --max-percentage 20
      
      - name: Verify Quality
        run: |
          python scripts/validate_test_quality.py --min-assertions 2
EOF

# 3. 검증 스크립트 설치
python scripts/enforce_test_integrity.py --install

echo "✅ Test Integrity System installed!"
```

## 3. 🔒 **우회 방지 메커니즘 (25% 비중)**

### AI 행동 패턴 차단:
```python
# scripts/block_ai_cheating.py

class AICheatBlocker:
    """AI의 테스트 우회 시도 차단"""
    
    FORBIDDEN_PATTERNS = [
        # 테스트 스킵
        (r"@pytest\.mark\.skip", "테스트 스킵 금지"),
        (r"@unittest\.skip", "테스트 스킵 금지"),
        
        # Theater Testing
        (r"assert.*is\s+not\s+None$", "의미없는 assertion"),
        (r"assert\s+True$", "항상 통과하는 테스트"),
        (r"pass\s*#.*test", "빈 테스트 본문"),
        
        # 테스트 삭제
        (r"^-.*def test_", "테스트 함수 삭제"),
        
        # Mock 남용
        (r"mock\.Mock\(\).*mock\.Mock\(\)", "과도한 Mock 사용")
    ]
    
    def scan_changes(self, diff_content):
        violations = []
        for pattern, message in self.FORBIDDEN_PATTERNS:
            if re.search(pattern, diff_content, re.MULTILINE):
                violations.append({
                    "pattern": pattern,
                    "message": message,
                    "severity": "HIGH"
                })
        
        if violations:
            self.block_commit(violations)
            return False
        return True
    
    def block_commit(self, violations):
        print("🚨 테스트 조작 시도 감지!")
        for v in violations:
            print(f"  ❌ {v['message']}")
        print("\n수정 방법:")
        print("  1. 실패하는 테스트를 삭제하지 말고 수정")
        print("  2. 구체적인 값을 검증하는 assertion 사용")
        print("  3. Mock 대신 실제 객체 사용")
        raise TestIntegrityViolation()
```

## 4. 📊 **실시간 모니터링 대시보드 (15% 비중)**

### 자동 생성 대시보드:
```python
def generate_integrity_dashboard():
    """테스트 무결성 실시간 대시보드"""
    
    stats = collect_test_statistics()
    violations = check_recent_violations()
    
    dashboard = f"""
╔════════════════════════════════════════════╗
║        TEST INTEGRITY DASHBOARD            ║
╠════════════════════════════════════════════╣
║ 📊 테스트 통계                            ║
║   Total: {stats['total']} ({stats['delta']:+d} from last)    ║
║   Pass Rate: {stats['pass_rate']:.1f}%                   ║
║   Coverage: {stats['coverage']:.1f}%                     ║
║   Mock Usage: {stats['mock_usage']:.1f}% {'✅' if stats['mock_usage'] < 20 else '❌'}      ║
╠════════════════════════════════════════════╣
║ 🚨 최근 위반 사항                         ║
"""
    
    for v in violations[-3:]:
        dashboard += f"║   • {v['time']}: {v['type']:20} ║\n"
    
    dashboard += """╠════════════════════════════════════════════╣
║ ✅ 강제 사항                              ║
║   • 테스트 삭제 불가                      ║
║   • Mock < 20%                            ║
║   • Assertion ≥ 2 per test                ║
║   • 모든 CI 체크 통과 필수                ║
╚════════════════════════════════════════════╝
"""
    return dashboard
```

## 5. 🎯 **완료 조건 및 검증**

**설치 완료 체크리스트:**
- [ ] Pre-commit hook 설치 및 작동
- [ ] GitHub Actions 워크플로우 활성화
- [ ] 검증 스크립트 모두 실행 가능
- [ ] 첫 테스트 실행 성공
- [ ] AI 우회 시도 차단 확인

**자동 검증:**
```bash
# 설치 검증
./scripts/verify_integrity_installation.sh

# 출력 예시:
✅ Pre-commit hooks: Installed
✅ GitHub Actions: Configured
✅ Python scripts: Available
✅ Test baseline: Recorded (127 tests)
✅ Mock detector: Active
🎉 Test Integrity System Ready!
```

**💡 슬래시 커맨드 실행 흐름:**
1. `/테스트강화` 실행
2. 현재 환경 자동 진단
3. 필요한 컴포넌트만 선택적 설치
4. 설치 검증 및 리포트
5. 실시간 대시보드 표시

**🚀 빠른 시작:**
```bash
# 한 줄로 모든 것 설치
curl -fsSL https://raw.githubusercontent.com/your-repo/main/install-test-integrity.sh | bash
```

**산출물: 완전한 테스트 무결성 시스템 + AI 우회 불가능한 환경**