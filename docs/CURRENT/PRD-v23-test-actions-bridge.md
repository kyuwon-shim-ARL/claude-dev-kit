# PRD v23: 테스트 생성-실행 완전 자동화 시스템

## 🎯 핵심 비전
Claude가 생성한 모든 테스트가 자동으로 GitHub Actions CI/CD 파이프라인에 통합되어 지속적으로 실행되는 완전 자동화 시스템

## 📌 문제 정의
- **현재**: 프롬프트로 테스트 생성 → 로컬 실행 → 끝
- **문제점**: 생성된 테스트가 일회성, CI/CD 단절
- **결과**: 회귀 테스트 불가, 품질 보증 체계 부재

## 🏗️ 솔루션: Test-Actions Bridge System

### 1. 테스트 생성 표준화

#### /구현 명령어 개선
```yaml
# 기존 프롬프트
/구현 "로그인 기능"
→ 코드 생성 + 간단한 테스트

# 개선된 프롬프트 (자동 CI 연동)
/구현 "로그인 기능"
→ 코드 생성
→ 테스트 생성 (표준 구조)
→ .github/tests/로 자동 저장
→ CI 워크플로우 자동 업데이트
```

#### 표준 테스트 구조
```python
# tests/auto_generated/test_[timestamp]_[feature].py
"""
Generated by Claude on 2025-08-30
Feature: 로그인 기능
Coverage: Unit + Integration
"""

import pytest
from src.auth import login

class TestAutoGenerated_Login:
    """자동 생성된 테스트는 특별한 네이밍 규칙 따름"""
    
    @pytest.mark.unit
    @pytest.mark.ci_required  # CI에서 필수 실행
    def test_valid_login(self):
        # Claude가 생성한 테스트 로직
        pass
    
    @pytest.mark.integration
    @pytest.mark.ci_optional  # CI에서 선택적 실행
    def test_login_workflow(self):
        # 통합 테스트 로직
        pass
```

### 2. 자동 CI 등록 시스템

#### 테스트 레지스트리
```yaml
# .github/test-registry.yml
# Claude가 테스트 생성할 때마다 자동 업데이트

tests:
  - id: test_2025_08_30_login
    path: tests/auto_generated/test_20250830_login.py
    created_by: claude
    date: 2025-08-30
    feature: 로그인 기능
    type: [unit, integration]
    priority: high
    ci_runs: always  # always | pr_only | nightly
    
  - id: test_2025_08_29_payment
    path: tests/auto_generated/test_20250829_payment.py
    created_by: claude
    date: 2025-08-29
    feature: 결제 시스템
    type: [unit, integration, e2e]
    priority: critical
    ci_runs: always
```

#### 동적 워크플로우 생성
```yaml
# .github/workflows/dynamic-tests.yml
# 레지스트리 기반으로 자동 생성되는 워크플로우

name: Auto-Generated Tests
on: [push, pull_request]

jobs:
  run-claude-tests:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        test: ${{ fromJson(needs.load-tests.outputs.tests) }}
    
    steps:
      - name: Run Test ${{ matrix.test.id }}
        run: |
          pytest ${{ matrix.test.path }} \
            --cov=src \
            --cov-report=xml:coverage-${{ matrix.test.id }}.xml
      
      - name: Upload Coverage
        uses: codecov/codecov-action@v3
        with:
          file: coverage-${{ matrix.test.id }}.xml
          flags: ${{ matrix.test.feature }}
```

### 3. 프롬프트-Actions 통합 플로우

#### Phase 1: 테스트 생성 시
```python
# Claude가 실행하는 스크립트
def register_test_to_ci(test_file, metadata):
    """생성된 테스트를 CI에 자동 등록"""
    
    # 1. 테스트 파일 저장
    save_test_file(test_file, "tests/auto_generated/")
    
    # 2. 레지스트리 업데이트
    update_test_registry({
        "id": generate_test_id(),
        "path": test_file.path,
        "created_by": "claude",
        "date": datetime.now(),
        "feature": metadata.feature,
        "type": metadata.test_types,
        "priority": metadata.priority,
        "ci_runs": determine_ci_frequency(metadata)
    })
    
    # 3. GitHub Actions 워크플로우 재생성
    regenerate_workflow(".github/workflows/dynamic-tests.yml")
    
    # 4. 커밋 및 푸시 (옵션)
    if auto_commit_enabled:
        git_commit_and_push("feat: Add auto-generated tests for {feature}")
```

#### Phase 2: CI 실행 시
```yaml
# GitHub Actions에서 실행되는 플로우
steps:
  - name: Load Test Registry
    id: registry
    run: |
      python scripts/load_test_registry.py > tests.json
      echo "tests=$(cat tests.json)" >> $GITHUB_OUTPUT
  
  - name: Filter Tests by Priority
    run: |
      # PR: high, critical만 실행
      # main: 모든 테스트 실행
      python scripts/filter_tests.py \
        --branch ${{ github.ref }} \
        --event ${{ github.event_name }}
  
  - name: Run Filtered Tests
    run: |
      pytest @filtered_tests.txt \
        --parallel 4 \
        --timeout 300
```

### 4. 테스트 결과 피드백 루프

#### 실패 분석 및 자동 수정
```python
# scripts/analyze_test_failures.py
def analyze_and_fix_failures():
    """테스트 실패를 분석하고 Claude에게 수정 요청"""
    
    failures = parse_test_results(".github/test-results/")
    
    for failure in failures:
        if failure.is_flaky:
            # Flaky 테스트는 재실행 마크
            mark_for_retry(failure.test_id)
        
        elif failure.is_outdated:
            # 구현 변경으로 인한 실패
            prompt = f"""
            테스트 {failure.test_id}가 실패했습니다.
            원인: {failure.reason}
            스택트레이스: {failure.stacktrace}
            
            이 테스트를 현재 구현에 맞게 수정해주세요.
            """
            # Claude에게 수정 요청 (자동화 가능)
            request_test_fix(prompt)
```

#### 커버리지 기반 테스트 생성 요청
```python
# scripts/coverage_gap_detector.py
def detect_coverage_gaps():
    """커버리지 부족 영역 감지 및 테스트 생성 요청"""
    
    coverage_report = load_coverage_report()
    
    gaps = find_uncovered_code(coverage_report)
    
    for gap in gaps:
        if gap.coverage < 60:  # 60% 미만
            prompt = f"""
            다음 코드의 테스트 커버리지가 {gap.coverage}%입니다:
            파일: {gap.file}
            함수: {gap.function}
            라인: {gap.lines}
            
            이 부분을 커버하는 테스트를 생성해주세요.
            """
            # 자동으로 테스트 생성 요청
            request_test_generation(prompt)
```

### 5. 실제 구현 예시

#### /구현 명령어 실행 시
```bash
# 사용자 입력
/구현 "사용자 프로필 업데이트 API"

# Claude 실행 과정
1. API 코드 생성 → src/api/profile.py
2. 테스트 생성 → tests/auto_generated/test_20250830_profile_api.py
3. 레지스트리 업데이트 → .github/test-registry.yml
4. 워크플로우 재생성 → .github/workflows/dynamic-tests.yml
5. 로컬 테스트 실행 → pytest tests/auto_generated/test_20250830_profile_api.py
6. 결과 표시 → "✅ 테스트 통과, CI에 자동 등록됨"
```

#### GitHub Actions 실행 시
```yaml
# 자동으로 실행되는 과정
1. Push/PR 트리거
2. 테스트 레지스트리 로드
3. 우선순위별 필터링
4. 병렬 테스트 실행
5. 커버리지 리포트
6. 실패 시 자동 분석
7. Slack/Discord 알림
```

## 📊 기대 효과

### 정량적 효과
- **테스트 커버리지**: 40% → 80%+ (자동 생성)
- **회귀 버그 감소**: 70% 감소 (지속적 실행)
- **테스트 작성 시간**: 80% 절감 (자동화)
- **CI 활용도**: 100% (모든 테스트 자동 등록)

### 정성적 효과
- **개발자 부담 감소**: 테스트 작성/관리 자동화
- **품질 보증 강화**: 모든 기능이 CI로 검증
- **피드백 속도**: 즉각적인 테스트 결과
- **확장성**: 무제한 테스트 추가 가능

## 🚀 구현 로드맵

### Week 1: 기반 구축
```bash
# 1. 테스트 레지스트리 시스템
touch .github/test-registry.yml
python scripts/create_registry_manager.py

# 2. 동적 워크플로우 생성기
python scripts/create_workflow_generator.py

# 3. 프롬프트 템플릿 업데이트
update_slash_commands("/구현", include_test_generation=True)
```

### Week 2: 통합 구현
```bash
# 1. Claude-Actions 브릿지
python scripts/implement_test_bridge.py

# 2. 자동 등록 시스템
python scripts/implement_auto_registration.py

# 3. 실패 분석기
python scripts/implement_failure_analyzer.py
```

### Week 3: 최적화 및 확장
```bash
# 1. 병렬 실행 최적화
optimize_parallel_execution()

# 2. 커버리지 갭 탐지
implement_coverage_gap_detector()

# 3. 자동 수정 시스템
implement_auto_fix_system()
```

## 💡 핵심 차별화

### 기존 방식 vs 새로운 방식

| 항목 | 기존 (프롬프트만) | 새로운 방식 (Actions 통합) |
|------|----------------|------------------------|
| 테스트 생성 | 일회성 | 영구 보존 + CI 등록 |
| 실행 주기 | 수동, 로컬만 | 자동, 모든 Push/PR |
| 회귀 테스트 | 불가능 | 완전 자동화 |
| 커버리지 추적 | 없음 | 실시간 모니터링 |
| 실패 처리 | 수동 확인 | 자동 분석 + 수정 요청 |
| 확장성 | 제한적 | 무제한 |

## ✅ 성공 기준

- [ ] 모든 `/구현` 명령이 자동으로 CI 테스트 생성
- [ ] 생성된 테스트 100% GitHub Actions 연동
- [ ] 테스트 실패 시 자동 분석 리포트
- [ ] 커버리지 80% 이상 자동 달성
- [ ] 회귀 버그 70% 감소

## 🔧 필요 도구

### 즉시 구현 가능
```yaml
# .github/workflows/test-bridge.yml
name: Test Bridge System
on:
  workflow_dispatch:  # 수동 트리거로 시작
    inputs:
      test_path:
        description: 'Generated test path'
        required: true

jobs:
  run-generated-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Run Claude-generated test
        run: |
          pytest ${{ github.event.inputs.test_path }}
```

### 스크립트 템플릿
```python
# scripts/register_test.py
#!/usr/bin/env python3
"""Claude가 테스트 생성 시 자동 실행"""

import yaml
import sys
from pathlib import Path

def register_test(test_file, metadata):
    registry_path = Path(".github/test-registry.yml")
    
    # 레지스트리 로드 또는 생성
    if registry_path.exists():
        with open(registry_path) as f:
            registry = yaml.safe_load(f)
    else:
        registry = {"tests": []}
    
    # 새 테스트 추가
    registry["tests"].append({
        "id": f"test_{metadata['timestamp']}_{metadata['feature']}",
        "path": str(test_file),
        "created_by": "claude",
        "date": metadata['date'],
        "feature": metadata['feature'],
        "type": metadata['types'],
        "priority": metadata['priority'],
        "ci_runs": "always"
    })
    
    # 저장
    with open(registry_path, 'w') as f:
        yaml.dump(registry, f, default_flow_style=False)
    
    print(f"✅ Test registered: {test_file}")
    return True

if __name__ == "__main__":
    # Claude가 호출할 때 사용
    register_test(sys.argv[1], eval(sys.argv[2]))
```

---

*이 시스템으로 프롬프트 기반 개발과 엔터프라이즈급 CI/CD가 완벽하게 통합됩니다.*